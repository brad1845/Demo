<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Viewer - Adaptive Joystick & Single Hand Mode</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/jesstelford/aframe-virtualjoystick-controls/dist/aframe-virtualjoystick-controls.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; }

    /* 手動 VR 按鈕 */
    #enterVR {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 5px;
      z-index: 999;
      font-size: 16px;
    }

    /* 單手模式切換按鈕 */
    #toggleMode {
      position: fixed;
      top: 70px;
      right: 20px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 5px;
      z-index: 999;
      font-size: 14px;
    }

    .joystick-container {
      position: fixed;
      bottom: 5%;
      width: 15vw;
      height: 15vw;
      max-width: 120px;
      max-height: 120px;
      min-width: 60px;
      min-height: 60px;
      background: rgba(0,0,0,0.3);
      border-radius: 50%;
      z-index: 998;
    }
    #leftJoystick { left: 5%; }
    #rightJoystick { right: 5%; }

    .stick {
      width: 40%;
      height: 40%;
      background: rgba(255,255,255,0.5);
      border-radius: 50%;
      position: absolute;
      top: 30%;
      left: 30%;
      touch-action: none;
      transition: top 0.2s ease, left 0.2s ease; /* 回彈動畫 */
    }
  </style>
</head>
<body>

<button id="enterVR">進入 VR</button>
<button id="toggleMode">單手模式</button>

<div id="leftJoystick" class="joystick-container">
  <div class="stick" id="leftStick"></div>
</div>
<div id="rightJoystick" class="joystick-container">
  <div class="stick" id="rightStick"></div>
</div>

<a-scene vr-mode-ui="enabled: false" embedded>
  <a-entity id="camera" camera
            look-controls="magicWindowTrackingEnabled: false; touchEnabled: false"
            virtual-joystick-controls="
              movementJoystick: #leftJoystick; 
              rotationJoystick: #rightJoystick"
            position="0 1.6 3">
  </a-entity>

  <a-assets>
    <a-asset-item id="livingroom" src="https://raw.githubusercontent.com/brad1845/Demo/main/living_room_indoor.glb"></a-asset-item>
  </a-assets>
  <a-entity gltf-model="#livingroom" position="0 0 -3" scale="1 1 1"></a-entity>

  <a-light type="ambient" color="#ffffff"></a-light>
  <a-light type="point" intensity="2" position="2 4 4"></a-light>

  <a-sky color="#ECECEC"></a-sky>
</a-scene>

<script>
const scene = document.querySelector('a-scene');
const camera = document.getElementById('camera');
const leftJoystick = document.getElementById('leftJoystick');
const rightJoystick = document.getElementById('rightJoystick');

let singleHandMode = false;

// 進入 VR
document.getElementById('enterVR').addEventListener('click', async () => {
  try {
    await scene.enterVR();
  } catch(e) {
    console.log("無法進入原生 VR，使用 Magic Window 模式");
  }
  camera.setAttribute('look-controls', 'magicWindowTrackingEnabled: true');
});

// 單手模式切換
document.getElementById('toggleMode').addEventListener('click', () => {
  singleHandMode = !singleHandMode;
  if(singleHandMode){
    rightJoystick.style.display = 'none';
    camera.setAttribute('look-controls', 'touchEnabled: true');
  } else {
    rightJoystick.style.display = 'block';
    camera.setAttribute('look-controls', 'touchEnabled: false');
  }
});

// 虛擬搖桿內圈回彈效果
function setupStick(stickId) {
  const stick = document.getElementById(stickId);
  let container = stick.parentElement;
  let active = false;
  let startX, startY;
  let maxRadius = container.offsetWidth/2 - stick.offsetWidth/2;

  stick.addEventListener('touchstart', e => {
    active = true;
    const touch = e.touches[0];
    startX = touch.clientX;
    startY = touch.clientY;
    stick.style.transition = "none";
  });

  stick.addEventListener('touchmove', e => {
    if (!active) return;
    const touch = e.touches[0];
    let dx = touch.clientX - startX;
    let dy = touch.clientY - startY;
    let distance = Math.hypot(dx, dy);
    if (distance > maxRadius) {
      let angle = Math.atan2(dy, dx);
      dx = Math.cos(angle)*maxRadius;
      dy = Math.sin(angle)*maxRadius;
    }
    stick.style.left = 30 + dx + "px";
    stick.style.top = 30 + dy + "px";
  });

  stick.addEventListener('touchend', e => {
    active = false;
    stick.style.transition = "top 0.2s ease, left 0.2s ease";
    stick.style.left = "30%";
    stick.style.top = "30%";
  });
}

setupStick('leftStick');
setupStick('rightStick');
</script>

</body>
</html>
