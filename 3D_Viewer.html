// 單手模式切換
document.getElementById('toggleMode').addEventListener('click', () => {
  if(!isMobile) return;
  singleHandMode = !singleHandMode;
  if(singleHandMode){
    leftJoystick.style.display = 'none';  // 左搖桿隱藏
    rightJoystick.style.display = 'block'; // 右搖桿用於移動
    camera.setAttribute('look-controls', 'touchEnabled: true'); // 滑動旋轉
    rightJoystick.setAttribute('data-mode', 'move'); // 標註右搖桿為移動
  } else {
    leftJoystick.style.display = 'block';
    rightJoystick.style.display = 'block';
    camera.setAttribute('look-controls', 'touchEnabled: false');
    rightJoystick.setAttribute('data-mode', 'rotate'); // 右搖桿為旋轉
  }
});

// 虛擬搖桿內圈回彈 & 功能
function setupStick(stickId){
  const stick = document.getElementById(stickId);
  const container = stick.parentElement;
  let active = false;
  let startX, startY;
  let maxRadius = container.offsetWidth/2 - stick.offsetWidth/2;

  stick.addEventListener('touchstart', e=>{
    active = true;
    const touch = e.touches[0];
    startX = touch.clientX;
    startY = touch.clientY;
    stick.style.transition = "none";
  });

  stick.addEventListener('touchmove', e=>{
    if(!active) return;
    const touch = e.touches[0];
    let dx = touch.clientX - startX;
    let dy = touch.clientY - startY;
    let distance = Math.hypot(dx, dy);
    if(distance>maxRadius){
      let angle = Math.atan2(dy, dx);
      dx = Math.cos(angle)*maxRadius;
      dy = Math.sin(angle)*maxRadius;
    }
    stick.style.left = 30+dx+"px";
    stick.style.top = 30+dy+"px";

    // 控制移動或旋轉
    let mode = stick.parentElement.getAttribute('data-mode');
    let moveSpeed = 0.05;
    if(mode==='move'){
      // 沿相機方向移動
      let dir = new THREE.Vector3();
      camera.object3D.getWorldDirection(dir);
      dir.y = 0; dir.normalize();
      let right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), dir).normalize();
      camera.object3D.position.add(dir.clone().multiplyScalar(-dy*moveSpeed));
      camera.object3D.position.add(right.clone().multiplyScalar(dx*moveSpeed));
    } else if(mode==='rotate'){
      // 旋轉相機
      let rotationSpeed = 0.1;
      camera.object3D.rotation.y -= dx*rotationSpeed*0.01;
      camera.object3D.rotation.x -= dy*rotationSpeed*0.01;
    }
  });

  stick.addEventListener('touchend', e=>{
    active = false;
    stick.style.transition = "top 0.2s ease, left 0.2s ease";
    stick.style.left = "30%";
    stick.style.top = "30%";
  });
}

// 初始化搖桿
if(isMobile){
  leftJoystick.setAttribute('data-mode','move');
  rightJoystick.setAttribute('data-mode','rotate');
  setupStick('leftStick');
  setupStick('rightStick');
}
